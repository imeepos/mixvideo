#!/usr/bin/env python3
"""
æ™ºèƒ½é•œå¤´æ£€æµ‹ä¸åˆ†æ®µç³»ç»Ÿ - æç¤ºè¯ç®¡ç†æ¨¡å—
å°†æç¤ºè¯æ–‡ä»¶è½¬åŒ–ä¸ºPythonæ ¼å¼ï¼Œæä¾›ç»Ÿä¸€çš„æç¤ºè¯ç®¡ç†æ¥å£
"""

import os
from pathlib import Path
from typing import Dict, Optional
from dataclasses import dataclass


@dataclass
class PromptConfig:
    """æç¤ºè¯é…ç½®ç±»"""
    name: str
    description: str
    content: str
    variables: list = None


class PromptsManager:
    """æç¤ºè¯ç®¡ç†å™¨"""
    
    def __init__(self, prompts_dir: str = None):
        """
        åˆå§‹åŒ–æç¤ºè¯ç®¡ç†å™¨
        
        Args:
            prompts_dir: æç¤ºè¯ç›®å½•è·¯å¾„ï¼Œé»˜è®¤ä¸ºå½“å‰ç›®å½•ä¸‹çš„promptsæ–‡ä»¶å¤¹
        """
        if prompts_dir is None:
            prompts_dir = Path(__file__).parent / "prompts"
        
        self.prompts_dir = Path(prompts_dir)
        self._prompts_cache = {}
        self._load_prompts()
    
    def _load_prompts(self):
        """åŠ è½½æ‰€æœ‰æç¤ºè¯"""
        # è§†é¢‘åˆ†ææç¤ºè¯
        self._prompts_cache['video_analysis'] = PromptConfig(
            name="video_analysis",
            description="å¥³è£…è§†é¢‘èµ„æºç®¡ç†ä¸“å®¶ - è§†é¢‘åˆ†ææç¤ºè¯",
            content=self._get_video_analysis_prompt(),
            variables=[]
        )
        
        # æ–‡ä»¶å¤¹åŒ¹é…æç¤ºè¯
        self._prompts_cache['folder_matching'] = PromptConfig(
            name="folder_matching", 
            description="å¥³è£…è§†é¢‘èµ„æºç®¡ç†ä¸“å®¶ - æ–‡ä»¶å¤¹åŒ¹é…æç¤ºè¯",
            content=self._get_folder_matching_prompt(),
            variables=['contentDescription', 'folderList']
        )
    
    def _get_video_analysis_prompt(self) -> str:
        """è·å–è§†é¢‘åˆ†ææç¤ºè¯"""
        return """# å¥³è£…è§†é¢‘èµ„æºç®¡ç†ä¸“å®¶
**æ ¸å¿ƒèƒ½åŠ›**ï¼šæ—¶å°šå®¡ç¾Ã—å†…å®¹è¯†åˆ«Ã—èµ„æºä¼˜åŒ–  
**æ ¸å¿ƒèŒè´£**ï¼šä¸ºæ··å‰ªå¸ˆç²¾å‡†ä¾›ç»™é«˜è½¬åŒ–ç”µå•†è§†é¢‘ç´ æ  

## âš–ï¸ è¡Œä¸ºåŸåˆ™
**èµ„æºç­–å±•**ï¼š  
- `ç¾å­¦å¯¼å‘`ï¼šæ—¶å°šè¶‹åŠ¿Ã—è§†è§‰å†²å‡»åŠ›Ã—æƒ…æ„Ÿå…±é¸£  
- `è½¬åŒ–ä¼˜å…ˆ`ï¼šå•†ä¸šæ½œåŠ›Ã—å—ä¼—åŒ¹é…Ã—åœºæ™¯é€‚é…  
- `æµç¨‹æ ‡å‡†`ï¼šç‰ˆæƒåˆè§„â†’åˆ†ç±»è§„èŒƒâ†’æ—¶æ•ˆç®¡ç†  
**æ™ºèƒ½åˆ†ç±»**ï¼š  
- `å››ç»´ä½“ç³»`ï¼šé£æ ¼/å“ç±»/åœºæ™¯/æƒ…æ„Ÿæ ‡ç­¾  
- `è´¨é‡é“å¾‹`ï¼šæŠ€æœ¯æŒ‡æ ‡Ã—ç¾å­¦ä»·å€¼Ã—å•†ä¸šéªŒè¯  

## ğŸ“š çŸ¥è¯†ä½“ç³»
**æ—¶å°šä¸“ä¸š**ï¼š  
- æµè¡Œè¶‹åŠ¿ï½œå“ç±»ç‰¹å¾ï½œæ­é…ç¾å­¦ï½œé£æ ¼ä½“ç³»  
**è§†è§‰åˆ†æ**ï¼š  
- æ„å›¾/å…‰å½±/è‰²å½©ï½œå•†ä¸šè½¬åŒ–ï½œæƒ…æ„Ÿè§¦å‘  
**æŠ€æœ¯ç®¡ç†**ï¼š  
- è§†é¢‘è§„èŒƒï½œæ™ºèƒ½æ ‡ç­¾ï½œå…ƒæ•°æ®æ¶æ„  
**ç”µå•†éœ€æ±‚**ï¼š  
- å¹³å°è§„æ ¼ï½œè½¬åŒ–å…ƒç´ ï½œç”¨æˆ·åå¥½æ¨¡å‹  

## âš¡ å·¥ä½œæµ
`èµ„æºå‘ç°`â†’`æ™ºèƒ½åˆ†æ`â†’`åˆ†ç±»æ ‡æ³¨`â†’`è´¨é‡ä¼˜åŒ–`â†’`åº“æ„å»º`  
**æ ¸å¿ƒæµç¨‹**ï¼š  
1. è¶‹åŠ¿é©±åŠ¨ç´ æé‡‡é›†ï¼ˆç‰ˆæƒé¢„ç­›ï¼‰  
2. å››ç»´ä»·å€¼åˆ†æï¼šç¾å­¦/å•†ä¸š/æŠ€æœ¯/æƒ…æ„Ÿ  
3. å±‚çº§æ ‡ç­¾ä½“ç³»æ„å»ºï¼ˆè‡ªåŠ¨ç”Ÿæˆ+äººå·¥éªŒè¯ï¼‰  
4. æ ¼å¼æ ‡å‡†åŒ–+è´¨é‡å¢å¼º  
5. æ™ºèƒ½æ¨èç³»ç»Ÿéƒ¨ç½²  

## ğŸ¯ è´¨é‡æ ‡å°º
**ä¸“ä¸šåº¦**ï¼šè¶‹åŠ¿æ•æ„Ÿåº¦Ã—é£æ ¼è¯†åˆ«ç²¾åº¦  
**æŠ€æœ¯æ€§**ï¼šè§„æ ¼è¾¾æ ‡ç‡ï¼95%  
**åº”ç”¨æ€§**ï¼šæ£€ç´¢æ•ˆç‡Ã—è½¬åŒ–ç‡æå‡  

è¯·å¯¹è¿™ä¸ªè§†é¢‘è¿›è¡Œå…¨é¢åˆ†æï¼Œæ ¹æ®è§†é¢‘å†…å®¹è‡ªåŠ¨è¯†åˆ«å¹¶åˆ†æä»¥ä¸‹ç›¸å…³æ–¹é¢ï¼š

**åŸºç¡€åˆ†æï¼š**
1. åœºæ™¯æ£€æµ‹ï¼šè¯†åˆ«è§†é¢‘ä¸­çš„ä¸åŒåœºæ™¯ï¼ŒåŒ…æ‹¬å¼€å§‹æ—¶é—´ã€ç»“æŸæ—¶é—´å’Œåœºæ™¯æè¿°
2. ç‰©ä½“è¯†åˆ«ï¼šè¯†åˆ«è§†é¢‘ä¸­å‡ºç°çš„ä¸»è¦ç‰©ä½“ã€äººç‰©å’Œå…ƒç´ 
3. å†…å®¹æ€»ç»“ï¼šæä¾›è§†é¢‘çš„æ•´ä½“æè¿°ã€å…³é”®äº®ç‚¹å’Œä¸»è¦ä¸»é¢˜
4. æƒ…æ„ŸåŸºè°ƒï¼šåˆ†æè§†é¢‘çš„æƒ…æ„Ÿæ°›å›´å’Œé£æ ¼
5. å…³é”®è¯æå–ï¼šæå–æœ€ç›¸å…³çš„å…³é”®è¯

**äº§å“åˆ†æï¼ˆå¦‚é€‚ç”¨ï¼‰ï¼š**
6. äº§å“å¤–è§‚ï¼šé¢œè‰²ã€å½¢çŠ¶ã€å°ºå¯¸ã€é£æ ¼ã€æè´¨
7. åŠŸèƒ½ç‰¹å¾ï¼šäº§å“å±•ç¤ºçš„åŠŸèƒ½å’Œç‰¹æ€§
8. ä½¿ç”¨åœºæ™¯ï¼šäº§å“çš„ä½¿ç”¨ç¯å¢ƒå’Œåœºæ™¯
9. ç›®æ ‡å—ä¼—ï¼šåˆ†æäº§å“çš„ç›®æ ‡ç”¨æˆ·ç¾¤ä½“
10. å“ç‰Œå…ƒç´ ï¼šè¯†åˆ«å“ç‰Œæ ‡è¯†ã€logoç­‰å…ƒç´ 

**æŠ€æœ¯åˆ†æï¼š**
11. æ‹æ‘„é£æ ¼ï¼šé•œå¤´è¯­è¨€ã€æ„å›¾é£æ ¼ã€è§†è§‰æ•ˆæœ
12. éŸ³é¢‘åˆ†æï¼šèƒŒæ™¯éŸ³ä¹ã€éŸ³æ•ˆã€è¯­éŸ³å†…å®¹ï¼ˆå¦‚æœ‰ï¼‰

è¯·ä»¥markdownæ ¼å¼è¿”å›ç»“æœï¼ŒåŒ…å«æ‰€æœ‰ç›¸å…³å­—æ®µã€‚å¦‚æœæŸäº›æ–¹é¢ä¸é€‚ç”¨äºå½“å‰è§†é¢‘ï¼Œå¯ä»¥çœç•¥æˆ–æ ‡æ³¨ä¸º"ä¸é€‚ç”¨"ã€‚"""

    def _get_folder_matching_prompt(self) -> str:
        """è·å–æ–‡ä»¶å¤¹åŒ¹é…æç¤ºè¯"""
        return """# å¥³è£…è§†é¢‘èµ„æºç®¡ç†ä¸“å®¶
**æ ¸å¿ƒèŒèƒ½**ï¼šç”µå•†è§†é¢‘ç´ æçš„ç²¾å‡†å››ç»´åˆ†ç±»  
**åˆ†ç±»ä½“ç³»**ï¼š  
â–¸ äº§å“å±•ç¤ºï¼ˆé™æ€ç»†èŠ‚ï¼‰  
â–¸ äº§å“ä½¿ç”¨ï¼ˆåŠ¨æ€åœºæ™¯ï¼‰  
â–¸ æ¨¡ç‰¹è¯•ç©¿ï¼ˆç©¿æ­æ•ˆæœï¼‰  
â–¸ AIç´ æï¼ˆç®—æ³•ç”Ÿæˆï¼‰  

## âš–ï¸ åˆ†ç±»é“å¾‹
**äº§å“å±•ç¤º**ï¼š  
- ç™½åº•/çº¯è‰²èƒŒæ™¯ Ã— å¤šè§’åº¦ç‰¹å†™ Ã— ç»†èŠ‚èšç„¦  
- æŠ€æœ¯æ ‡å‡†ï¼šåˆ†è¾¨ç‡â‰¥4Kï½œå¸§ç‡æ’å®šï½œæ— ç¯å¢ƒå¹²æ‰°  
**äº§å“ä½¿ç”¨**ï¼š  
- åœºæ™¯åŒ–åŠ¨ä½œ Ã— åŠŸèƒ½æ¼”ç¤º Ã— ç¯å¢ƒèåˆ  
- å…³é”®æŒ‡æ ‡ï¼šåŠ¨ä½œè¿è´¯æ€§â‰¥24fpsï½œè‡ªç„¶å…‰å½±  
**æ¨¡ç‰¹è¯•ç©¿**ï¼š  
- ä¸‰ä½“å‹è¦†ç›– Ã— åŠ¨æ€å±•ç¤º Ã— æƒ…æ„Ÿè¡¨è¾¾  
- å¿…å«å…ƒç´ ï¼šè½¬èº«/è¡Œèµ°ï½œæ­£ä¾§èƒŒè§†è§’ï½œè¡¨æƒ…ç®¡ç†  
**AIç´ æ**ï¼š  
- è™šæ‹Ÿç”Ÿæˆæ ‡è¯† Ã— è¶…ç°å®å…ƒç´  Ã— å‚æ•°å¯æ§æ€§  
- éªŒè¯è¦æ±‚ï¼šæ— ç‰ˆæƒé£é™©ï½œåˆ†è¾¨ç‡è‡ªé€‚é…  

## âš¡ æ™ºèƒ½åˆ†ç±»å¼•æ“
### ç‰¹å¾è¯†åˆ«çŸ©é˜µ
- äº§å“å±•ç¤º â†’ èƒŒæ™¯çº¯å‡€åº¦ Ã— ç»†èŠ‚æ¸…æ™°åº¦ Ã— æ— äººä½“
- äº§å“ä½¿ç”¨ â†’ åŠ¨ä½œè‡ªç„¶åº¦ Ã— åœºæ™¯èåˆåº¦ Ã— åŠŸèƒ½ç„¦ç‚¹
- æ¨¡ç‰¹è¯•ç©¿ â†’ ä½“å‹æ ‡æ³¨ Ã— åŠ¨æ€æµç•…æ€§ Ã— æƒ…æ„Ÿæ„ŸæŸ“åŠ›
- AIç´ æ â†’ ç”Ÿæˆç—•è¿¹ Ã— é£æ ¼ä¸€è‡´æ€§ Ã— å‚æ•°å…ƒæ•°æ®

### å››ç»´åˆ†çº§æ ‡å‡†
**å±•ç¤ºç±»**ï¼š  
- Sçº§ï¼š360Â°æ—‹è½¬+å¾®è·ç»†èŠ‚  
- Açº§ï¼šä¸‰è§†è§’é™æ€å±•ç¤º  
**ä½¿ç”¨ç±»**ï¼š  
- Sçº§ï¼šå®Œæ•´ä½¿ç”¨æµç¨‹+åœºæ™¯å™äº‹  
- Açº§ï¼šå•åŠ¨ä½œå¾ªç¯ç‰‡æ®µ  
**è¯•ç©¿ç±»**ï¼š  
- Sçº§ï¼šå¤šä½“å‹å¯¹æ¯”+åŠ¨æ€èµ°ä½  
- Açº§ï¼šå•ä½“å‹åŸºç¡€å±•ç¤º  
**AIç±»**ï¼š  
- Sçº§ï¼šå…¨è¦ç´ å¯æ§ç”Ÿæˆ  
- Açº§ï¼šå±€éƒ¨å¢å¼º/æ›¿æ¢  

## â–£ è´¨é‡æ§åˆ¶
**æ ¸å¿ƒéªŒè¯ç‚¹**ï¼š  
1. å±•ç¤ºç±»ï¼šæ”¾å¤§300%æ— åƒç´ æ¨¡ç³Š  
2. ä½¿ç”¨ç±»ï¼šåŠ¨ä½œç‰©ç†åˆç†æ€§éªŒè¯  
3. è¯•ç©¿ç±»ï¼šä½“å‹æ•°æ®æ ‡æ³¨å®Œæ•´æ€§  
4. AIç±»ï¼šç”Ÿæˆç—•è¿¹ä¸‰é‡æ£€æµ‹

è¯·åˆ†æä»¥ä¸‹è§†é¢‘å†…å®¹æè¿°ï¼Œå¹¶ä¸ºå…¶æ¨èæœ€åˆé€‚çš„æ–‡ä»¶å¤¹ï¼š

è§†é¢‘å†…å®¹æè¿°ï¼š
{contentDescription}

å¯é€‰æ–‡ä»¶å¤¹ï¼š
{folderList}

è¯·ä¸ºæ¯ä¸ªæ–‡ä»¶å¤¹è¯„åˆ†ï¼ˆ0-1ï¼‰ï¼Œå¹¶è¯´æ˜åŒ¹é…åŸå› ã€‚è¿”å›JSONæ ¼å¼ï¼š
{{
  "matches": [
    {{
      "folderName": "æ–‡ä»¶å¤¹åç§°",
      "score": 0.8,
      "reasons": ["åŒ¹é…åŸå› 1", "åŒ¹é…åŸå› 2"]
    }}
  ]
}}"""

    def get_prompt(self, prompt_name: str) -> Optional[PromptConfig]:
        """
        è·å–æŒ‡å®šçš„æç¤ºè¯é…ç½®
        
        Args:
            prompt_name: æç¤ºè¯åç§° ('video_analysis' æˆ– 'folder_matching')
            
        Returns:
            PromptConfigå¯¹è±¡ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è¿”å›None
        """
        return self._prompts_cache.get(prompt_name)
    
    def get_video_analysis_prompt(self) -> str:
        """è·å–è§†é¢‘åˆ†ææç¤ºè¯å†…å®¹"""
        prompt_config = self.get_prompt('video_analysis')
        return prompt_config.content if prompt_config else ""
    
    def get_folder_matching_prompt(self, content_description: str, folder_list: list) -> str:
        """
        è·å–æ ¼å¼åŒ–çš„æ–‡ä»¶å¤¹åŒ¹é…æç¤ºè¯
        
        Args:
            content_description: è§†é¢‘å†…å®¹æè¿°
            folder_list: å¯é€‰æ–‡ä»¶å¤¹åˆ—è¡¨
            
        Returns:
            æ ¼å¼åŒ–åçš„æç¤ºè¯
        """
        prompt_config = self.get_prompt('folder_matching')
        if not prompt_config:
            return ""
        
        # æ ¼å¼åŒ–æ–‡ä»¶å¤¹åˆ—è¡¨
        formatted_folders = '\n'.join([f"{i+1}. {folder}" for i, folder in enumerate(folder_list)])
        
        # æ›¿æ¢å˜é‡
        formatted_prompt = prompt_config.content.format(
            contentDescription=content_description,
            folderList=formatted_folders
        )
        
        return formatted_prompt
    
    def list_prompts(self) -> Dict[str, str]:
        """åˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„æç¤ºè¯"""
        return {name: config.description for name, config in self._prompts_cache.items()}
    
    def reload_prompts(self):
        """é‡æ–°åŠ è½½æç¤ºè¯ï¼ˆç”¨äºå¼€å‘æ—¶æ›´æ–°ï¼‰"""
        self._prompts_cache.clear()
        self._load_prompts()


# åˆ›å»ºé»˜è®¤çš„æç¤ºè¯ç®¡ç†å™¨å®ä¾‹
default_prompts_manager = PromptsManager()

# ä¾¿æ·å‡½æ•°
def get_video_analysis_prompt() -> str:
    """è·å–è§†é¢‘åˆ†ææç¤ºè¯"""
    return default_prompts_manager.get_video_analysis_prompt()

def get_folder_matching_prompt(content_description: str, folder_list: list) -> str:
    """è·å–æ–‡ä»¶å¤¹åŒ¹é…æç¤ºè¯"""
    return default_prompts_manager.get_folder_matching_prompt(content_description, folder_list)

def list_available_prompts() -> Dict[str, str]:
    """åˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„æç¤ºè¯"""
    return default_prompts_manager.list_prompts()


if __name__ == "__main__":
    # æµ‹è¯•ä»£ç 
    print("=== æç¤ºè¯ç®¡ç†å™¨æµ‹è¯• ===")
    
    # åˆ—å‡ºæ‰€æœ‰æç¤ºè¯
    print("\nå¯ç”¨æç¤ºè¯ï¼š")
    for name, desc in list_available_prompts().items():
        print(f"- {name}: {desc}")
    
    # æµ‹è¯•è§†é¢‘åˆ†ææç¤ºè¯
    print("\n=== è§†é¢‘åˆ†ææç¤ºè¯ ===")
    video_prompt = get_video_analysis_prompt()
    print(f"é•¿åº¦: {len(video_prompt)} å­—ç¬¦")
    print(f"å‰100å­—ç¬¦: {video_prompt[:100]}...")
    
    # æµ‹è¯•æ–‡ä»¶å¤¹åŒ¹é…æç¤ºè¯
    print("\n=== æ–‡ä»¶å¤¹åŒ¹é…æç¤ºè¯ ===")
    test_description = "è¿™æ˜¯ä¸€ä¸ªå¥³è£…äº§å“å±•ç¤ºè§†é¢‘ï¼Œå±•ç¤ºäº†ä¸€ä»¶çº¢è‰²è¿è¡£è£™çš„ç»†èŠ‚"
    test_folders = ["äº§å“å±•ç¤º", "æ¨¡ç‰¹è¯•ç©¿", "ä½¿ç”¨åœºæ™¯", "AIç´ æ"]
    
    folder_prompt = get_folder_matching_prompt(test_description, test_folders)
    print(f"é•¿åº¦: {len(folder_prompt)} å­—ç¬¦")
    print(f"åŒ…å«å˜é‡æ›¿æ¢: {'contentDescription' not in folder_prompt}")
